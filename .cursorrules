AI-Assisted Counseling MVP (Node.js, Express, Socket.IO, Pug, Prisma/SQLite) 프로젝트 규칙
==========================================================================================

## 0. 서비스 목적
- 이 서비스는 상담 중 AI의 도움을 받아 답변 초안을 얻으려는 심리상담사를 위한 보조 도구다.
- 상담의 1차적 책임과 최종 결정권은 항상 인간 상담사에게 있으며 AI는 답변을 추천할 뿐 직접 응답하지 않는다.

## 1. 기술 스택 / 전반
- Node.js + Express + Socket.IO + Pug를 기본으로 사용한다. React/Next/Vue 등은 사용자가 명시적으로 요청할 때만 도입한다.
- 백엔드는 순수 JavaScript(ESM)로 작성하며 TypeScript 파일은 만들지 않는다.
- 프론트엔드는 Pug + 바닐라 JS만 사용하고, Webpack/Vite 등 빌드 도구나 프론트엔드 프레임워크는 추가하지 않는다.

## 2. 코드 스타일
- 최신 JS 기능을 사용할 수 있지만 optional chaining(?.), nullish coalescing(??), 논리 할당 연산자(??=, &&=, ||=)는 쓰지 않는다. 대신 if 문 또는 전통적인 || 연산을 사용해 명시적으로 처리한다.
- 구조 분해 할당(`const { a, b } = obj`)은 필요 시 사용한다.
- 화살표 함수는 허용하지만 복잡하거나 가독성이 떨어지면 일반 함수로 작성한다.
- 불필요한 추상화(서비스 레이어, 복잡한 클래스, DI 컨테이너 등)는 피하고 함수 기반으로 단순하게 구현한다.

## 3. 라우팅 / 서버 구조
- Express 라우트는 단순하게 유지하며 로그인/회원가입/권한 관리는 구현하지 않는다.
- 환경 변수는 `.env`에서 로드하고, API 키나 시크릿을 코드에 하드코딩하지 않는다.

## 4. Socket.IO / 역할 구조
- Socket.IO 방은 20자리 `code` 값을 기준으로 하고 역할은 `client`(내담자), `counselor`(상담사) 두 가지다.
- 이벤트 이름(`client_message`, `counselor_generate`, `counselor_refine`, `counselor_send_final`)과 현재 역할 분리 흐름을 유지한다.
- AI 초안(`ai_draft`)은 상담사 화면에만 표시하며 내담자와 상담사 역할 로직을 절대 섞지 않는다.

## 5. OpenAI 사용 방식
- 공식 `openai` Node SDK와 Responses API만 사용하며 프론트엔드에서 직접 OpenAI를 호출하지 않는다.
- `new OpenAI({ apiKey: process.env.OPENAI_API_KEY })` 형태를 유지한다.
- Responses API 호출 시 기본 모델은 `gpt-5.1`이며, instructions/developer 프롬프트에는 바이런 케이티의 ‘The Work’ 네 가지 질문 철학을 반영한다.

## 6. DB / Prisma 지침
- 데이터베이스는 SQLite + Prisma를 사용하며, 향후 Supabase/Postgres로 옮길 때를 고려해 스키마 의존성을 최소화한다.
- 메시지는 세션 단위로 모두 저장해 분석과 개선에 활용할 수 있도록 한다.
- ORM은 Prisma만 사용한다.
- 사용자가 DB 도입을 명시적으로 요청하지 않는 한, DB 작업은 추가하지 않는다.
- 최소한 아래 정보는 영구 저장한다:
  - 세션(방) 정보: 20자리 room code, 생성 시각, 내담자/상담사 이름, OpenAI conversation ID
  - 메시지: 소속 방, 발신자(client/counselor/ai), 텍스트, 전송 시각, 내담자에게 노출 여부(AI 초안 등 메타 정보)

## 7. 프론트엔드 / UI
- 템플릿 엔진은 Pug를 사용하며 주석을 남기지 않는다.
- CSS는 `mvp.css`, `styles.css` 두 파일만 사용하고 인라인 스타일은 최소화한다.
- 내담자와 상담사 화면은 레이아웃을 유사하게 유지하되 상담사 화면은 오른쪽에 AI 보조 패널이 있는 2열 구조를 유지한다.

## 8. MVP 범위 관리
- 이 프로젝트는 AI 보조 심리상담 MVP이므로 비즈니스 가설 검증에 필요한 최소 기능만 구현한다.
- 사용자 인증, 결제, 관리자 대시보드, 복잡한 권한 시스템 등은 도입하지 않는다.
- 기능 제안 시 기존 흐름(방 코드 생성 → 입장 → 채팅 → AI 초안 생성/수정 → 최종 메시지 전송)을 해치지 않는다.

## 9. 핵심 기능
- 상담사는 방 코드를 생성하고 내담자와 상담사가 동일한 코드로 입장해 1:1 세션을 진행한다.
- 내담자 메시지는 두 사용자 모두에게 실시간으로 표시되며 동시에 AI 응답 생성 입력으로 활용될 수 있다.
- AI가 생성한 답변 초안은 상담사 화면에서만 보이며 내담자 화면에는 절대 노출되지 않는다.
- AI 답변은 자동 전송되지 않고 상담사가 초안을 검토해 수정 지시를 내리거나 최종 답변으로 전송해야 한다.
- 최종 답변으로 전송된 메시지만 내담자 화면의 본 채팅에 기록되며, AI 초안 및 수정 과정은 상담사 전용 히스토리로만 남는다.
- 로그인/회원가입과 복잡한 권한 관리는 도입하지 않으며, 방 코드와 세션 단위만으로 사용자를 구분한다.

## 10. Non-Goals
- AI가 내담자와 직접 대화하거나 상담사 승인 없이 자동 응답하는 기능은 구현하지 않는다.
- 장기 치료 계획 수립, 공식 진단, 법률/재정 자문 등은 서비스 목적 범위를 벗어난다.
- 다자간 회의, 다양한 역할, 관리자 대시보드 등 복잡한 워크플로우는 MVP 단계에서 제외한다.

## 11. 공식 문서 참조
- https://platform.openai.com/docs/guides/text
- https://platform.openai.com/docs/api-reference/responses
- https://platform.openai.com/docs/guides/conversation-state?api-mode=responses
- Responses API 관련 코드는 최신 공식 문서를 근거로 작성하며, 확실하지 않은 내용은 생성하지 않는다.